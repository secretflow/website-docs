:target{#ç‰¹å¾å·¥ç¨‹}

# ç‰¹å¾å·¥ç¨‹

> The following codes are demos only. Itâ€™s <strong>NOT for production</strong> due to system security concerns, please <strong>DO NOT</strong> use it directly in production.

æ¨èä½¿ç”¨ [jupyter](https://jupyter.org/) è¿è¡Œæœ¬æ•™ç¨‹ã€‚

Secretflow æä¾›äº†å¤šç§å·¥å…·æ¥åˆ†ææ•°æ®é›†ï¼Œä»¥æé«˜æœºå™¨å­¦ä¹ ç»“æœçš„è´¨é‡ã€‚

:target{#åˆå§‹åŒ–}

## åˆå§‹åŒ–

åˆå§‹åŒ–Secretflowï¼Œå¹¶åˆ›å»ºalice/bobä¸¤ä¸ªè®¡ç®—å‚ä¸æ–¹å…¼æ•°æ®æä¾›æ–¹ã€‚

> ğŸ’¡ Before using preprocessing, you may need to get to know secretflowâ€™s [DataFrame](../preprocessing/DataFrame.mdx).

<Notebook.Cell>
  <Notebook.CodeArea prompt="[13]:" stderr={false} type="input">
    ```python
    import secretflow as sf

    # In case you have a running secretflow runtime already.
    sf.shutdown()

    sf.init(['alice', 'bob'], address='local')
    alice = sf.PYU('alice')
    bob = sf.PYU('bob')

    spu = sf.SPU(sf.utils.testing.cluster_def(['alice', 'bob']))
    ```
  </Notebook.CodeArea>
</Notebook.Cell>

:target{#å‡†å¤‡Demoæ•°æ®}

## å‡†å¤‡Demoæ•°æ®

ä½¿ç”¨ä¸€ç»„çº¿æ€§æ‹Ÿåˆæ•°æ®ä½œä¸ºç¤ºä¾‹ã€‚

<Notebook.Cell>
  <Notebook.CodeArea prompt="[14]:" stderr={false} type="input">
    ```python
    from secretflow.utils.simulation.datasets import load_linear

    vdf = load_linear(parts={alice: (1, 4), bob: (18, 22)})

    label_data = vdf["y"]
    vdf = vdf.drop(columns="y")

    print(f"orig ds in alice:\n {sf.reveal(vdf.partitions[alice].data)}")
    print(f"orig ds in bob:\n {sf.reveal(vdf.partitions[bob].data)}")
    ```
  </Notebook.CodeArea>

  <Notebook.CodeArea prompt="" stderr={false} type="output">
    <pre>
      {"orig ds in alice:\n             x1        x2        x3\n0    -0.514226  0.730010 -0.730391\n1    -0.725537  0.482244 -0.823223\n2     0.608353 -0.071102 -0.775098\n3    -0.686642  0.160470  0.914477\n4    -0.198111  0.212909  0.950474\n...        ...       ...       ...\n9995 -0.367246 -0.296454  0.558596\n9996  0.010913  0.629268 -0.384093\n9997 -0.238097  0.904069 -0.344859\n9998  0.453686 -0.375173  0.899238\n9999 -0.776015 -0.772112  0.012110\n\n[10000 rows x 3 columns]\norig ds in bob:\n            x18       x19       x20\n0     0.810261  0.048303  0.937679\n1     0.312728  0.526637  0.589773\n2     0.039087 -0.753417  0.516735\n3    -0.855979  0.250944  0.979465\n4    -0.238805  0.243109 -0.121446\n...        ...       ...       ...\n9995 -0.847253  0.069960  0.786748\n9996 -0.502486 -0.076290 -0.604832\n9997 -0.424209  0.434947  0.998955\n9998  0.914291 -0.473056  0.616257\n9999 -0.602927 -0.021368  0.885519\n\n[10000 rows x 3 columns]\n"}
    </pre>
  </Notebook.CodeArea>
</Notebook.Cell>

:target{#çš®å°”é€Šç§¯çŸ©ç›¸å…³ç³»æ•°}

## çš®å°”é€Šç§¯çŸ©ç›¸å…³ç³»æ•°

çš®å°”é€Šç§¯çŸ©ç›¸å…³ç³»æ•°å¯ä»¥ç”¨æ¥æ¢æŸ¥ä¸¤ä¸ªå˜é‡X/Yä¹‹é—´çš„çº¿æ€§ç›¸å…³æ€§çš„å¼ºåº¦ã€‚

ä¸¤ä¸ªå˜é‡ä¹‹é—´çš„çš®å°”é€Šç§¯çŸ©ç›¸å…³ç³»æ•°å®šä¹‰ä¸ºä¸¤ä¸ªå˜é‡çš„åæ–¹å·®é™¤ä»¥å…¶æ ‡å‡†å·®çš„ä¹˜ç§¯ï¼š

<Math>
  $$
  \rho_{X,Y}=\frac{cov(X, Y)}{\sigma_X \sigma_Y}=\frac{(X-\mu_X)(Y-\mu_Y)}{\sigma_X \sigma_Y}


  $$
</Math>

<Math>
  $$
  \mu_X= \mathbb{E}(X), \sigma_X^2=\mathbb{E}[(X-\mathbb{E}(X))^2]=\mathbb{E}(X^2)-\mathbb{E}^2(X)


  $$
</Math>

æ•°æ®é›†ä¸­æ ·æœ¬ï¼ˆç‰¹å¾ï¼‰çš„çš®å°”é€Šç§¯çŸ©ç›¸å…³ç³»æ•°ï¼Œé€šå¸¸ç”¨å°å†™å­—æ¯ r è¡¨ç¤ºï¼š

<Math>
  $$
  r=\frac{\sum^n_{i=1}(X_i-\bar{X})(Y_i-\bar{Y})}{\sqrt{\sum^n_{i=1}(X_i-\bar{X})^2} \sqrt{\sum^n_{i=1}(Y_i-\bar{Y})^2}}


  $$
</Math>

å…¶å€¼ä»‹äº-1ä¸1ä¹‹é—´ã€‚ <InlineMath>$r>0$</InlineMath> å¯¹åº”ä¸¤è€…æ­£ç›¸å…³ï¼Œåä¹‹ä¸ºè´Ÿç›¸å…³ï¼› <InlineMath>$|r|$</InlineMath> è¶Šå¤§ï¼Œç›¸å…³ç¨‹åº¦è¶Šå¤§ã€‚

:target{#SSVertPearsonR}

### SSVertPearsonR

SecretFlow çš„ `SSVertPearsonR` æ¨¡å—å¯ä»¥ç”¨äºæ¢æŸ¥å‚ç›´åˆ’åˆ†æ•°æ®é›†çš„çš®å°”é€Šç§¯çŸ©ç›¸å…³ç³»æ•°ï¼Œè®¡ç®—è¿‡ç¨‹ä½¿ç”¨ç§˜å¯†åˆ†äº«åè®®ä¿æŠ¤ã€‚

SSVertPearsonR will standardize input dataset first. After standardized, all featuresâ€™ variance is 1 and the mean is 0, the calculation is simplified to:

<Math>
  $$
  r=\frac{1}{n-1}X^TX


  $$
</Math>

<Notebook.Cell>
  <Notebook.CodeArea prompt="[15]:" stderr={false} type="input">
    ```python
    from secretflow.stats import SSVertPearsonR

    v_pearsonr = SSVertPearsonR(spu)
    corr = v_pearsonr.pearsonr(vdf)
    print(f"corr: \n {corr}")
    ```
  </Notebook.CodeArea>

  <Notebook.CodeArea prompt="" stderr={false} type="output">
    <pre>
      {"corr:\n [[ 1.0001000e+00  2.4262429e-03 -5.3907027e-03 -7.7360502e-04\n  -7.4419454e-03 -1.0678579e-02]\n [ 2.4262429e-03  1.0001000e+00 -5.4155029e-03 -2.0672032e-03\n   4.3277428e-03  3.7399144e-03]\n [-5.3907027e-03 -5.4155029e-03  1.0001000e+00  6.2504560e-03\n  -3.7937090e-03  7.3285382e-03]\n [-7.7360502e-04 -2.0672032e-03  6.2504560e-03  1.0001000e+00\n  -1.0416691e-02  1.0044558e-02]\n [-7.4419454e-03  4.3277428e-03 -3.7937090e-03 -1.0416691e-02\n   1.0001000e+00 -1.3045982e-02]\n [-1.0678579e-02  3.7399144e-03  7.3285382e-03  1.0044558e-02\n  -1.3045982e-02  1.0001000e+00]]\n"}
    </pre>
  </Notebook.CodeArea>
</Notebook.Cell>

:target{#æ–¹å·®æ‰©å¤§å› å­}

## æ–¹å·®æ‰©å¤§å› å­

æ–¹å·®æ‰©å¤§å› å­ (VIF) ç”¨äºæ¢æŸ¥å˜é‡ä¹‹é—´çš„å¤šé‡å…±çº¿æ€§ã€‚åœ¨ä¸€ä¸ªçº¿æ€§ç»Ÿè®¡æ¨¡å‹ä¸­ï¼Œä¸€ä¸ªç³»æ•°çš„æ–¹å·®æ‰©å¤§å› å­ç­‰äºå¤šå…ƒæ¨¡å‹ä¸­è¯¥ç³»æ•°æ–¹å·®ä¸ä¸€å…ƒæ¨¡å‹ä¸­è¯¥ç³»æ•°æ–¹å·®çš„å•†ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯è§£é‡Šå˜é‡ï¼ˆç‰¹å¾ï¼‰ä¹‹é—´å­˜åœ¨å¤šé‡å…±çº¿æ€§æ—¶çš„æ–¹å·®ä¸ä¸å­˜åœ¨å¤šé‡å…±çº¿æ€§æ—¶çš„æ–¹å·®ä¹‹æ¯”ã€‚

:target{#SSVertVIF}

### SSVertVIF

SecretFlow çš„ `SSVertVIF` æ¨¡å—å¯ä»¥ç”¨äºæ¢æŸ¥å‚ç›´åˆ’åˆ†æ•°æ®é›†çš„æ–¹å·®æ‰©å¤§å› å­ï¼Œè®¡ç®—è¿‡ç¨‹ä½¿ç”¨ç§˜å¯†åˆ†äº«åè®®ä¿æŠ¤ã€‚

ç¬¬jä¸ªç‰¹å¾çš„vifå€¼ä¸ºï¼š

<Math>
  $$
  VIF_j = (X^TX)^{-1}_{jj}(n-1)var(X_j)


  $$
</Math>

æ³¨æ„ï¼š

åœ¨ç§˜å¯†åˆ†äº«åè®®ä¸‹è®¡ç®—çŸ©é˜µé€†å¼€é”€éå¸¸å¤§ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ç‰›é¡¿è¿­ä»£è¿›è¡Œè¿‘ä¼¼ã€‚

å½“è¾“å…¥æ•°æ®é›†ä¸­å­˜åœ¨å®Œå…¨çº¿æ€§ç›¸å…³æ—¶ï¼Œ <InlineMath>$X^TX$</InlineMath> çŸ©é˜µä¸æ»¡ç§©ï¼Œ <InlineMath>$X^TX$</InlineMath> çŸ©é˜µé€†çš„è§£æè§£ä¸å­˜åœ¨ã€‚

statsmodelsåœ¨å®Œå…¨çº¿æ€§ç›¸å…³åˆ—ä¸Šè®¡ç®—çš„VIFä¸ºINFï¼Œæ„ä¸ºæ— é™å¤§çš„ç›¸å…³æ€§ã€‚è€Œæˆ‘ä»¬æä¾›çš„æ¨¡å—ä¼šè¾“å‡ºä¸€ä¸ªå¾ˆå¤§çš„å€¼(>>1000)ï¼Œä¹Ÿèƒ½æ­£ç¡®çš„è¡¨ç¤ºè¿™äº›åˆ—ä¹‹é—´å­˜åœ¨å¾ˆå¼ºçš„ç›¸å…³æ€§ã€‚

å¯¹äºå¸¸é‡åˆ—ï¼Œstatsmodelsçš„ç»“æœæ˜¯NANï¼Œæˆ‘ä»¬çš„æ¨¡å—ä¾ç„¶æ˜¯å¾ˆå¤§çš„å€¼(>>1000)ï¼Œè¡¨æ˜è¿™ä¸ªåˆ—åœ¨å»ºæ¨¡å‰éœ€è¦è¢«å‰”é™¤ã€‚

æ‰€ä»¥æœ¬æ¨¡å—çš„ç»“æœè™½ç„¶æ— æ³•å’Œstatemodelsè¿™ç±»æ˜æ–‡è®¡ç®—çš„ç»“æœå®Œå…¨ä¸€è‡´ï¼Œä½†ä¾ç„¶èƒ½æ­£ç¡®çš„åæ˜ å‡ºç‰¹å¾é—´çš„ç›¸å…³æ€§ã€‚

<Notebook.Cell>
  <Notebook.CodeArea prompt="[16]:" stderr={false} type="input">
    ```python
    from secretflow.stats import SSVertVIF

    v_vif = SSVertVIF(spu)
    vif = v_vif.vif(vdf)
    print(f"vif: \n{vif}")
    ```
  </Notebook.CodeArea>

  <Notebook.CodeArea prompt="" stderr={false} type="output">
    <pre>
      {"vif:\n[0.9999169 0.9997679 0.9999169 0.9999169 1.0000659 1.0002149]\n"}
    </pre>
  </Notebook.CodeArea>
</Notebook.Cell>

:target{#çº¿æ€§æ¨¡å‹/å¹¿ä¹‰çº¿æ€§æ¨¡å‹ç³»æ•°æ˜¾è‘—æ£€éªŒ}

## çº¿æ€§æ¨¡å‹/å¹¿ä¹‰çº¿æ€§æ¨¡å‹ç³»æ•°æ˜¾è‘—æ£€éªŒ

çº¿æ€§/é€»è¾‘å›å½’å˜é‡æ˜¾è‘—æ€§æ£€éªŒç”¨äºåˆ¤æ–­ç‰¹å¾ï¼ˆè§£é‡Šå˜é‡ï¼‰æ˜¯å¦æ˜¾è‘—ï¼Œå³è‡ªå˜é‡æ˜¯å¦èƒ½æœ‰æ•ˆé¢„æµ‹å› å˜é‡çš„å˜åŒ–ï¼Œä»è€Œåˆ¤æ–­å¯¹åº”çš„è§£é‡Šå˜é‡æ˜¯å¦åº”è¢«åŒ…å«åœ¨æ¨¡å‹ä¸­ã€‚

:target{#çº¿æ€§å›å½’ç³»æ•°æ˜¾è‘—æ£€éªŒ}

### çº¿æ€§å›å½’ç³»æ•°æ˜¾è‘—æ£€éªŒ

å¯¹çº¿æ€§å›å½’ <InlineMath>$y=XÏ‰$</InlineMath> ï¼ˆXåŒ…å«å¸¸æ•°é¡¹ï¼‰ï¼Œä½¿ç”¨tæ£€éªŒæ¥å¯¹å›å½’é¡¹ç³»æ•°æ£€éªŒå…¶å€¼æ˜¯å¦ä¸ºé›¶ã€‚

å…¶ä¸­ï¼š

<Math>
  $$
  \hat{Ï‰}=(X^T X)^{-1} X^T y=Ï‰+(X^T X)^{-1} X^T Îµ


  $$
</Math>

<Math>
  $$
  E(\hat{Ï‰})=Ï‰


  $$
</Math>

<Math>
  $$
  Var(\hat{Ï‰} )=Ïƒ^2 (X^T X)^{-1}


  $$
</Math>

åœ¨æœ€å°äºŒä¹˜æ³•5æ¡å‡è®¾éƒ½æˆç«‹çš„æƒ…å†µä¸‹ï¼Œç»Ÿè®¡é‡ï¼š

<Math>
  $$
  t_j=\frac{\hat{Ï‰}_j- Ï‰_j}{s.e.(Ï‰_j )}=\frac{\hat{Ï‰}_j - Ï‰_j}{\sqrt{\hat{Ïƒ}^2 (X^T X)_{jj}^{-1}}}  \sim t_{n-k}


  $$
</Math>

å…¶ä¸­ï¼Œnä¸ºæ ·æœ¬é‡ï¼Œkä¸ºç‰¹å¾æ•°

æ£€éªŒçš„åŸå‡è®¾å’Œå¤‡æ‹©å‡è®¾ä¸ºï¼š

<Math>
  $$
   \begin{aligned}
  & H_0:Ï‰_j=0 (j=1,2,â‹¯,k) \\ & H_1:Ï‰_jâ‰ 0
  \end{aligned}
  $$
</Math>

å°†æ£€éªŒçš„åŸå‡è®¾å¸¦å…¥ <InlineMath>$t_j$</InlineMath> ï¼š

<Math>
  $$
  t_j=\frac{\hat{Ï‰}_j}{s.e.(Ï‰_j )}=\frac{\hat{Ï‰}_j}{\sqrt{\hat{Ïƒ}^2 (X^T X)_{jj}^{-1}}}  \sim t_{n-k}


  $$
</Math>

:target{#é€»è¾‘å›å½’ç³»æ•°æ˜¾è‘—æ£€éªŒ}

### é€»è¾‘å›å½’ç³»æ•°æ˜¾è‘—æ£€éªŒ

å¯¹äºé€»è¾‘å›å½’

<Math>
  $$
   P(y=1|x)=Ï€(x)=1/(1+e^{-Ï‰x} ) \\
  P(y=0|x)=1-Ï€(x)=1/(1+e^{Ï‰x} )
  $$
</Math>

æ£€éªŒçš„åŸå‡è®¾å’Œå¤‡æ‹©å‡è®¾ä¸ºï¼š

<Math>
  $$
   \begin{aligned}
  & H_0:Ï‰_j=0 (j=1,2,â‹¯,k) \\
  & H_1:Ï‰_jâ‰ 0
  \end{aligned}
  $$
</Math>

Wald test <InlineMath>$Wald=(\hat{Ï‰}_k/SE(\hat{Ï‰}_k ) )^2$</InlineMath> ç¬¦åˆè‡ªç”±åº¦ä¸º1çš„å¡æ–¹åˆ†å¸ƒã€‚

å…¶ä¸­ <InlineMath>$SE(\hat{Ï‰}_k )$</InlineMath> æ˜¯ <InlineMath>$Ï‰_k$</InlineMath> çš„æ ‡å‡†è¯¯å·®, ä¸ºæ–¹å·®åæ–¹å·®çŸ©é˜µçš„å¯¹è§’å…ƒç´ çš„å¹³æ–¹æ ¹ï¼š

<Math>
  $$
  SE(\hat{Ï‰}_k )={Cov(\hat{Ï‰}_{kk})}^{1/2}


  $$
</Math>

æ¨¡å‹å‚æ•°çš„æ–¹å·®å’Œåæ–¹å·®çŸ©é˜µï¼Œä¸ºå¯¹æ•°ä¼¼ç„¶å‡½æ•°çš„HessiançŸ©é˜µçš„é€†åœ¨ <InlineMath>$\hat{Ï‰}$</InlineMath> å¤„çš„å€¼ï¼š

<Math>
  $$
  Cov(\hat{Ï‰}) =H^{-1}=\frac{âˆ‚^2 l(Ï‰)}{âˆ‚Ï‰^2}|_{\hat{Ï‰}}


  $$
</Math>

å…¶ä¸­ï¼š

<Math>
  $$
  H_{kr}=\frac{âˆ‚^2l(Ï‰)}{âˆ‚Ï‰_k âˆ‚Ï‰_r}=âˆ‘_{i=1}^mx_{ik}Ï€(x_i)[Ï€(x_i )-1]x_{ir}


  $$
</Math>

HessiançŸ©é˜µè¡¨ç¤ºä¸º <InlineMath>$H=X^T A X$</InlineMath>ï¼Œ AçŸ©é˜µä¸ºï¼š

<Math>
  $$
   \begin{aligned}
  & A_{ii} = Ï€(x_{i})[Ï€(x_{i}) - 1] \\
  & A_{ij} = 0 , iâ‰ j
  \end{aligned}
  $$
</Math>

å¯å¾—ï¼š

<Math>
  $$
   \begin{aligned}
  Wald & = (\hat{Ï‰}_k/SE(\hat{Ï‰}_k ) )^2 \\
  & = \hat{Ï‰}_k^2 /Cov(\hat{Ï‰}_{kk}) \\
  & = \hat{Ï‰}_k^2 / H^{-1}_{kk} \\
  & = \hat{Ï‰}_k^2 / (X^T \Lambda X )^{-1}_{kk}
  \end{aligned}
  $$
</Math>

:target{#SSPValue}

### SSPValue

SecretFlow çš„ `SSPValue` æ¨¡å—å¯ä»¥ç”¨äºæ¢æŸ¥æ¨¡å‹çš„P-Valueï¼Œè®¡ç®—è¿‡ç¨‹ä½¿ç”¨ç§˜å¯†åˆ†äº«åè®®ä¿æŠ¤ã€‚

çº¿æ€§å›å½’æ¨¡å‹ï¼š

- è®¡ç®—é¢„æµ‹æ®‹å·® <InlineMath>$\hat{Îµ}=XÏ‰ - y$</InlineMath>
- è®¡ç®— <InlineMath>$\hat{Ïƒ}^2=\hat{Îµ}^T\hat{Îµ} /(n-k)$</InlineMath>
- é€šè¿‡ç‰›é¡¿è¿­ä»£è®¡ç®— <InlineMath>$(X^T X)^{-1}$</InlineMath>
- <InlineMath>$t^2= Ï‰^2 / \hat{Ïƒ}^2(X^T X)_{jj}^{-1}$</InlineMath>
- <InlineMath>$p =2 * (1 - t_{n-k}.cdf(|t|))$</InlineMath>

é€»è¾‘å›å½’æ¨¡å‹ï¼š

- è®¡ç®— <InlineMath>$H=X^TAX$</InlineMath>
- é€šè¿‡ç‰›é¡¿è¿­ä»£è®¡ç®— <InlineMath>$H^{-1}$</InlineMath>
- è®¡ç®— <InlineMath>$z^2=Ï‰^2/H^{-1}_{kk}$</InlineMath>
- <InlineMath>$p = 2 * (1 - norm.cdf(|z|))$</InlineMath>

<Notebook.Cell>
  <Notebook.CodeArea prompt="[19]:" stderr={false} type="input">
    ```python
    from secretflow.stats import SSPValue
    from secretflow.ml.linear.ss_sgd import SSRegression

    # first, get a LR model
    model = SSRegression(spu)
    model.fit(
        vdf,
        label_data,
        3,  # epochs
        0.3,  # Learning rate
        64,  # batch_size
        't1',  # sig_type
        'logistic',  # reg_type
        'l2',  # penalty
        0.5,  # l2_norm
    )
    spu_model = model.save_model()

    sspv = SSPValue(spu)
    pvalues = sspv.pvalues(vdf, label_data, spu_model)
    print(f"logistic pvalue: \n{pvalues}")
    ```
  </Notebook.CodeArea>

  <Notebook.CodeArea prompt="" stderr={false} type="output">
    <pre>
      {"logistic pvalue:\n[9.46532264e-08 0.00000000e+00 0.00000000e+00 0.00000000e+00\n 8.21281902e-07 0.00000000e+00 0.00000000e+00]\n"}
    </pre>
  </Notebook.CodeArea>
</Notebook.Cell>
