:target{#scql-config-manual}

# SCQL 配置手册

本配置手册旨在帮助用户了解 SCQL 系统可用的各种配置选项。 它可以分为两部分：SCDB 配置选项和Engine 配置选项。

:target{#scdb-configuration-options}

## SCDB 配置选项

在 SCDB 中配置参数以 yaml 文件形式提供。

:target{#example-for-scdb}

### SCDB 配置示例

```yaml
scdb_host: http://localhost:8080
port: 8080
protocol: http
query_result_callback_timeout: 200ms
session_expire_time: 1h
session_expire_check_time: 100ms
password_check: true
log_level: debug
security_compromise:
  reveal_group_mark: false
storage:
  type: mysql
  conn_str: user_name:pass_word@tcp(127.0.0.1:3306)/db_name?charset=utf8mb4&parseTime=True&loc=Local&interpolateParams=true
  max_idle_conns: 10
  max_open_conns: 100
  conn_max_idle_time: 2m
  conn_max_lifetime: 5m
grm:
  grm_mode: stdgrm
  host: http://your-grm-host
  timeout: 5s
engine:
    timeout: 120s
    protocol: http
    content_type: application/json
    spu:
      protocol: SEMI2K
      field: FM64
      sigmoid_mode: SIGMOID_REAL
```

:target{#config-in-scdb}

### SCDB 配置项

<table>
  <thead>
    <tr>
      <td>
        名称
      </td>

      <td>
        默认值
      </td>

      <td>
        描述
      </td>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        scdb\_host
      </td>

      <td>
        无
      </td>

      <td>
        引擎通知SCDB的回调URL
      </td>
    </tr>

    <tr>
      <td>
        端口
      </td>

      <td>
        无
      </td>

      <td>
        SCDB服务器监听端口
      </td>
    </tr>

    <tr>
      <td>
        协议
      </td>

      <td>
        http
      </td>

      <td>
        SCDB服务器传输协议支持HTTP/HTTPS
      </td>
    </tr>

    <tr>
      <td>
        query\_result\_callback\_timeout
      </td>

      <td>
        200毫秒
      </td>

      <td>
        Timeout for SCDB to notify the query result
      </td>
    </tr>

    <tr>
      <td>
        session\_expire\_time
      </td>

      <td>
        48小时
      </td>

      <td>
        会话超时时间
      </td>
    </tr>

    <tr>
      <td>
        session\_expire\_check\_time
      </td>

      <td>
        1小时
      </td>

      <td>
        超时会话的清理间隔
      </td>
    </tr>

    <tr>
      <td>
        password\_check
      </td>

      <td>
        正确
      </td>

      <td>
        创建用户时是否验证密码强度
      </td>
    </tr>

    <tr>
      <td>
        log\_level
      </td>

      <td>
        info
      </td>

      <td>
        记录事件的类型和严重性
      </td>
    </tr>

    <tr>
      <td>
        security\_compromise.reveal\_group\_mark
      </td>

      <td>
        false
      </td>

      <td>
        是否在计算 group by 的时候泄露分组标记信息
      </td>
    </tr>

    <tr>
      <td>
        tls.cert\_file
      </td>

      <td>
        无
      </td>

      <td>
        启用支持crt/pem类型的TSL证书文件路径
      </td>
    </tr>

    <tr>
      <td>
        tls.key\_file
      </td>

      <td>
        无
      </td>

      <td>
        启用支持key/pem类型的TLS私钥文件路径
      </td>
    </tr>

    <tr>
      <td>
        storage.type
      </td>

      <td>
        无
      </td>

      <td>
        SCDB的数据库类型支持 MYSQL/SQLite3
      </td>
    </tr>

    <tr>
      <td>
        storage.conn\_str
      </td>

      <td>
        无
      </td>

      <td>
        用于连接到数据库
      </td>
    </tr>

    <tr>
      <td>
        storage.max\_idle\_conns
      </td>

      <td>
        1
      </td>

      <td>
        Maximum number of connections in idle connection pool
      </td>
    </tr>

    <tr>
      <td>
        storage.max\_open\_conns
      </td>

      <td>
        1
      </td>

      <td>
        数据库最大连接数
      </td>
    </tr>

    <tr>
      <td>
        storage.conn\_max\_idle\_time
      </td>

      <td>
        \-1s
      </td>

      <td>
        连接处于空闲状态的最长时间
      </td>
    </tr>

    <tr>
      <td>
        storage.conn\_max\_lifetime
      </td>

      <td>
        \-1s
      </td>

      <td>
        可重复连接使用的最长时间
      </td>
    </tr>

    <tr>
      <td>
        grm.grm\_mode
      </td>

      <td>
        无
      </td>

      <td>
        支持 toygrm/stdgrm的grm 服务类型
      </td>
    </tr>

    <tr>
      <td>
        grm.host
      </td>

      <td>
        无
      </td>

      <td>
        stdgrm主机
      </td>
    </tr>

    <tr>
      <td>
        grm.timeout
      </td>

      <td>
        无
      </td>

      <td>
        SCDB 从 stdgrm 获取信息超时
      </td>
    </tr>

    <tr>
      <td>
        grm.toy\_grm\_conf
      </td>

      <td>
        无
      </td>

      <td>
        toygrm路径配置
      </td>
    </tr>

    <tr>
      <td>
        engine.timeout
      </td>

      <td>
        无
      </td>

      <td>
        SCDB 向引擎发送消息超时
      </td>
    </tr>

    <tr>
      <td>
        engine.protocol
      </td>

      <td>
        https
      </td>

      <td>
        引擎传输协议支持http/https
      </td>
    </tr>

    <tr>
      <td>
        engine.content\_type
      </td>

      <td>
        无
      </td>

      <td>
        从 SCDB 到引擎所发送的正文中原始媒体类型
      </td>
    </tr>

    <tr>
      <td>
        engine.spu.protocol
      </td>

      <td>
        无
      </td>

      <td>
        引擎使用的 mpc 协议
      </td>
    </tr>

    <tr>
      <td>
        engine.spu.field
      </td>

      <td>
        无
      </td>

      <td>
        引擎所使用的安全参数类型
      </td>
    </tr>

    <tr>
      <td>
        engine.spu.sigmoid\_mode
      </td>

      <td>
        无
      </td>

      <td>
        引擎使用的类似Sigmoid方法
      </td>
    </tr>
  </tbody>
</table>

:target{#config-for-securitycompromise}

#### 安全退让配置

SCDB 提供了一些安全妥协选项，当安全风险可以接受时可以选择性地启用这些选项，以加快整体运行速度

1. reveal\_group\_mark:

> default disable, if enabled, SCDB will expose grouping information(size of each group) when calculating group-by-aggregation, thereby avoiding the overhead caused by pre-shuffle.  <code>risk</code>: group size will be leaked, which is equivalent to the result of count(\*)

典型的配置如下：

```yaml
security_compromise:
  reveal_group_mark: false
```

:target{#config-for-storage}

#### 存储配置

SCDB中的数据库用于存储SCQL系统数据，如CCL和用户信息，目前SCDB支持MySQL/SQLite3。 您可以通过在存储配置中设置“conn\_str”和“type”来连接到数据库。

<DefinitionList>
  <dl>
    <dt>
      <DefinitionList.Term><span>类型</span></DefinitionList.Term>
    </dt>

    <dd>
      数据库类型可以设置为mysql/sqlite，推荐经过充分测试的MySQL。
    </dd>

    <dt>
      <DefinitionList.Term><span>conn\_str</span></DefinitionList.Term>
    </dt>

    <dd>
      MySQL语句格式：

      >       <LineBlock>
      >         \[username\[:password]@]\[protocol\[(address)]]/dbname\[?param1=value1&…\&paramN=valueN]
      >
      >         <em>see</em> [dsn-data-source-name](https://github.com/go-sql-driver/mysql#dsn-data-source-name) <em>for more infos</em>.
      >       </LineBlock>

      MySQL语句示例：

      > user\:pass\@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4\&parseTime=True\&loc=Local\&interpolateParams=true

      SQLite3语句格式：

      > 更多信息: [https://github.com/mattn/go-sqlite3#connection-string](https://github.com/mattn/go-sqlite3#connection-string).

      SQLite3语句示例：

      > scdb.db
    </dd>
  </dl>
</DefinitionList>

典型的存储配置如下：

```yaml
storage:
  type: mysql
  conn_str: user_name:pass_word@tcp(127.0.0.1:3306)/db_name?charset=utf8mb4&parseTime=True&loc=Local&interpolateParams=true
  max_idle_conns: 10
  max_open_conns: 100
  conn_max_idle_time: 2m
  conn_max_lifetime: 5m
```

<Container type="note">
  正确处理 time.Time需要包含 parseTime 参数。为了完全支持UTF-8编码，需要更改 “charset=utf8 to charset=utf8mb4”
</Container>

:target{#password-check}

#### PassWord Check

“password\_check”用于验证密码强度。 对于 ALTER USER、CREATE USER 语句，如果为 true，则密码应至少为 16 个字符，其中包括数字、小写字母、大写字母和特殊字符。

:target{#config-for-grm}

#### GRM配置

GRM服务除了由开发人员提供外，还可以通过读取本地JSON文件来模拟，用于测试和开发，您可以如下选择。

<DefinitionList>
  <dl>
    <dt>
      <DefinitionList.Term><span>stdgrm</span></DefinitionList.Term>
    </dt>

    <dd>
      如果您想使用自己开发的GRM服务，则grm\_mode需要设置为stdgrm。
    </dd>
  </dl>
</DefinitionList>

```yaml
grm:
  grm_mode: stdgrm
  host: ${host of grm service} # eg. http://localhost:8080
  timeout: ${timeout of grm service} # eg. 2m
```

<DefinitionList>
  <dl>
    <dt>
      <DefinitionList.Term><span>toygrm</span></DefinitionList.Term>
    </dt>

    <dd>
      如果想直接从json文件模拟GRM服务，除了将grm\_mode设置为toygrm外，还需要设置toy\_grm\_conf。
    </dd>
  </dl>
</DefinitionList>

```yaml
grm:
  grm_mode: toygrm
  toy_grm_conf: ${file path of toy grm config} # eg. toy_grm.json
```

:target{#config-for-tls}

#### TLS配置

如果需要在SCDB中启用TLS，请参考以下配置。

```yaml
scdb_host: ${host of scdb service}  # eg. https://localhost:8080
protocol: https
tls:
  cert_file: ${file path of server cert}  # eg. path_of_server_cert.pem
  key_file: ${file path of server key}  # eg. path_of_server_key.pem
engine:
  protocol: https
```

此外，还需要配置引擎以使用 SSL，请参阅“SSL 配置”

:target{#config-for-spu}

#### SPU配置

SCQL 支持 SPU 支持的不同 mpc 协议，您可以通过设置 SPU 运行时配置来选择不同的 mpc 协议，建议使用经过充分测试并支持多方的 SEMI2K 协议。 请参阅“ SPU 配置”\<[https://www.secretflow.org.cn/docs/spu/en/reference/runtime\_config.html](https://www.secretflow.org.cn/docs/spu/en/reference/runtime_config.html)>获得更多信息

```yaml
spu:
  protocol: SEMI2K
  field: FM64
  sigmoid_mode: SIGMOID_REAL
```

:target{#engine-configuration-options}

## 引擎配置选项

SCQLEngine 设置时使用 Gflags 来管理配置。

:target{#example-for-engine}

### 引擎示例

```default
# Config for Brpc server
--listen_port=8003
# Config for datasource
--datasource_router=embed
--embed_router_conf={"datasources":[{"id":"ds001","name":"mysql db","kind":"MYSQL","connection_str":"${connection_str}"}],"rules":[{"db":"*","table":"*","datasource_id":"ds001"}]}
```

:target{#config-in-engine}

### Engine配置

<table>
  <thead>
    <tr>
      <td>
        名称
      </td>

      <td>
        默认值
      </td>

      <td>
        描述
      </td>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        log\_dir
      </td>

      <td>
        日志
      </td>

      <td>
        保存log文件的目录
      </td>
    </tr>

    <tr>
      <td>
        log\_enable\_console\_logger
      </td>

      <td>
        正确
      </td>

      <td>
        是否记录日志文件到 stdout
      </td>
    </tr>

    <tr>
      <td>
        peer\_engine\_protocol
      </td>

      <td>
        <cite>http\:proto</cite>
      </td>

      <td>
        引擎与引擎之间的rpc协议
      </td>
    </tr>

    <tr>
      <td>
        peer\_engine\_connection\_type
      </td>

      <td>
        pooled
      </td>

      <td>
        The rpc connection type between engine and engine
      </td>
    </tr>

    <tr>
      <td>
        peer\_engine\_timeout\_ms
      </td>

      <td>
        300000
      </td>

      <td>
        引擎与引擎之间的rpc超时时间，单位：ms
      </td>
    </tr>

    <tr>
      <td>
        peer\_engine\_max\_retry
      </td>

      <td>
        3
      </td>

      <td>
        引擎与引擎之间的rpc最大重试次数（不包括第一个rpc）
      </td>
    </tr>

    <tr>
      <td>
        peer\_engine\_enable\_ssl\_as\_client
      </td>

      <td>
        正确
      </td>

      <td>
        向其他引擎发送消息时是否启用ssl加密
      </td>
    </tr>

    <tr>
      <td>
        peer\_engine\_enable\_ssl\_client\_verification
      </td>

      <td>
        false
      </td>

      <td>
        向其他引擎发送消息时是否启用证书验证
      </td>
    </tr>

    <tr>
      <td>
        peer\_engine\_ssl\_client\_ca\_certificate
      </td>

      <td>
        无
      </td>

      <td>
        向另一个引擎发送消息时用于验证证书 CA 文件
      </td>
    </tr>

    <tr>
      <td>
        link\_recv\_timeout\_ms
      </td>

      <td>
        30000
      </td>

      <td>
        引擎等待其他引擎消息的最大时间
      </td>
    </tr>

    <tr>
      <td>
        scdb\_protocol
      </td>

      <td>
        <cite>http\:proto</cite>
      </td>

      <td>
        引擎与SCDB之间的rpc协议
      </td>
    </tr>

    <tr>
      <td>
        scdb\_connection\_type
      </td>

      <td>
        pooled
      </td>

      <td>
        引擎与SCDB之间的rpc连接类型
      </td>
    </tr>

    <tr>
      <td>
        scdb\_timeout\_ms
      </td>

      <td>
        5000
      </td>

      <td>
        引擎与SCDB之间的rpc超时时间，单位：ms
      </td>
    </tr>

    <tr>
      <td>
        scdb\_max\_retry
      </td>

      <td>
        3
      </td>

      <td>
        引擎和SCDB之间的rpc最大重试次数（不包括第一个rpc）
      </td>
    </tr>

    <tr>
      <td>
        scdb\_enable\_ssl\_as\_client
      </td>

      <td>
        正确
      </td>

      <td>
        向 SCDB 发送消息时是否启用 ssl 加密
      </td>
    </tr>

    <tr>
      <td>
        scdb\_enable\_ssl\_client\_verification
      </td>

      <td>
        false
      </td>

      <td>
        向SCDB发送消息时是否启用证书验证
      </td>
    </tr>

    <tr>
      <td>
        scdb\_ssl\_client\_ca\_certificate
      </td>

      <td>
        无
      </td>

      <td>
        向 SCDB 发送消息时用于验证证书的 CA 文件
      </td>
    </tr>

    <tr>
      <td>
        listen\_port
      </td>

      <td>
        8003
      </td>

      <td>
        引擎服务监听端口
      </td>
    </tr>

    <tr>
      <td>
        enable\_builtin\_service
      </td>

      <td>
        false
      </td>

      <td>
        是否启用brpc内置服务
      </td>
    </tr>

    <tr>
      <td>
        internal\_port
      </td>

      <td>
        9527
      </td>

      <td>
        brpc内置服务的监听端口
      </td>
    </tr>

    <tr>
      <td>
        idle\_timeout\_s
      </td>

      <td>
        30
      </td>

      <td>
        引擎与 SCDB 之间的空闲连接关闭延迟（以秒为单位）
      </td>
    </tr>

    <tr>
      <td>
        server\_enable\_ssl
      </td>

      <td>
        正确
      </td>

      <td>
        引擎作为服务器时是否启用SSL
      </td>
    </tr>

    <tr>
      <td>
        server\_ssl\_certificate
      </td>

      <td>
        无
      </td>

      <td>
        引擎作为服务器时启用 SSL 的证书文件路径
      </td>
    </tr>

    <tr>
      <td>
        server\_ssl\_private\_key
      </td>

      <td>
        无
      </td>

      <td>
        引擎作为服务器时启用 SSL 的私钥文件路径
      </td>
    </tr>

    <tr>
      <td>
        enable\_client\_authorization
      </td>

      <td>
        false
      </td>

      <td>
        当引擎作为服务器时是否检查请求的http 头部
      </td>
    </tr>

    <tr>
      <td>
        auth\_credential
      </td>

      <td>
        无
      </td>

      <td>
        检查请求http头部用于授权
      </td>
    </tr>

    <tr>
      <td>
        enable\_scdb\_authorization
      </td>

      <td>
        false
      </td>

      <td>
        是否启动SCDB身份认证
      </td>
    </tr>

    <tr>
      <td>
        engine\_credential
      </td>

      <td>
        无
      </td>

      <td>
        用于验证 SCDB 的凭证
      </td>
    </tr>

    <tr>
      <td>
        session\_timeout\_s
      </td>

      <td>
        1800
      </td>

      <td>
        引擎与SCDB之间的会话过期时间，单位：秒
      </td>
    </tr>

    <tr>
      <td>
        datasource\_router
      </td>

      <td>
        嵌入的
      </td>

      <td>
        数据源路由类型
      </td>
    </tr>

    <tr>
      <td>
        embed\_router\_conf
      </td>

      <td>
        无
      </td>

      <td>
        json 格式的嵌入路由配置
      </td>
    </tr>

    <tr>
      <td>
        db\_connection\_info
      </td>

      <td>
        无
      </td>

      <td>
        用于连接mysql的连接字符串
      </td>
    </tr>

    <tr>
      <td>
        enable\_he\_schema\_type\_ou
      </td>

      <td>
        false
      </td>

      <td>
        是否使用OU算法来加速 HeSum, 考虑到更优的安全性，默认使用 ZPaillier, 参见: [heu/ou](https://www.secretflow.org.cn/docs/heu/latest/zh-Hans/getting_started/algo_choice#ou-paillier)
      </td>
    </tr>
  </tbody>
</table>

:target{#config-for-datasource}

#### 数据源配置

SCQLEngine 支持多种数据源，包括 MySQL/SQLite3/PostgreSQL/CSVDB 。

<em>datasource\_router</em> is design to support multi datasources, currently only supported: embed.

embed\_router is initialized with <em>embed\_router\_conf</em> first, a json string like:

```default
"datasources": [
  {
    "id": "ds001",
    "name": "mysql db for scql",
    "kind": "MYSQL",
    "connection_str": "${connection_str}"
  }
],
"rules":[
  {
    "db": "*",
    "table": "*",
    "datasource_id": "ds001"
  }
]
```

if <em>embed\_router\_conf</em> is empty, embed\_router will try to initialized with <em>db\_connection\_info</em>.

:target{#embed-router}

##### 嵌入式路由

embed\_router\_conf 中的 datasources 包含用于连接 MySQL/SQLite3/PostgreSQL/CSVDB 数据源的信息:

> id：数据源的唯一ID。
>
> name：自定义描述，有助于区分数据源。
>
> kind：数据源类型，目前支持MySQL/SQLite3/PostgreSQL/CSVDB。
>
> connection\_str：用于连接MySQL/SQLite3/PostgreSQL/CSVDB的字符串。
>
> > <DefinitionList>
> >   <dl>
> >     <dt>
> >       <DefinitionList.Term><span>MySQL连接字符串格式：</span></DefinitionList.Term>
> >     </dt>
> >
> >     <dd>
> >       \<str> == \<assignment> | \<assignment> ‘;’ \<str>
> >       \<assignment> == \<name> ‘=’ \<value>
> >       \<name> == ‘host’ | ‘port’ | ‘user’ | ‘password’ | ‘db’ | ‘compress’ | ‘auto-reconnect’ | ‘reset’ | ‘fail-readonly’
> >       \<value> == \[\~;]\*
> >     </dd>
> >
> >     <dt>
> >       <DefinitionList.Term><span>MySQL连接字符串示例：</span></DefinitionList.Term>
> >     </dt>
> >
> >     <dd>
> >       “db=$\{db};user=$\{user};password=$\{password};host=$\{host}”
> >     </dd>
> >
> >     <dt>
> >       <DefinitionList.Term><span>SQLite3连接字符串格式：</span></DefinitionList.Term>
> >     </dt>
> >
> >     <dd>
> >       更多信息：[https://www.sqlite.org/c3ref/open.html](https://www.sqlite.org/c3ref/open.html)
> >     </dd>
> >
> >     <dt>
> >       <DefinitionList.Term><span>SQLite3连接字符串示例</span></DefinitionList.Term>
> >     </dt>
> >
> >     <dd>
> >       “[file\:data\_test.db?mode=memory\&cache=shared](file:///data_test.db.mdx?mode=memory\&cache=shared)”
> >     </dd>
> >
> >     <dt>
> >       <DefinitionList.Term><span>PostgreSQL 连接字符串格式：</span></DefinitionList.Term>
> >     </dt>
> >
> >     <dd>
> >       \<str> == \<assignment> | \<assignment> ‘ ‘ \<str>
> >       \<assignment> == \<name> ‘=’ \<value>
> >       \<name> == ‘host’ | ‘port’ | ‘user’ | ‘password’ | ‘dbname’ | ‘connect\_timeout’
> >       \<value> == \[\~;]\*
> >     </dd>
> >
> >     <dt>
> >       <DefinitionList.Term><span>PostgreSQL 连接字符串示例：</span></DefinitionList.Term>
> >     </dt>
> >
> >     <dd>
> >       “db=$\{db};user=$\{user};password=$\{password};host=$\{host}”
> >     </dd>
> >
> >     <dt>
> >       <DefinitionList.Term><span>CSVDB 连接字符串格式：</span></DefinitionList.Term>
> >     </dt>
> >
> >     <dd>
> >       由于connection\_str是另一个json对象中的对象，因此格式为CsvdbConf对应的转换后的json字符串 \<[https://github.com/secretflow/scql/tree/main/engine/datasource/csvdb\_conf.proto](https://github.com/secretflow/scql/tree/main/engine/datasource/csvdb_conf.proto)>
> >     </dd>
> >
> >     <dt>
> >       <DefinitionList.Term><span>CSVDB连接语句示例:</span></DefinitionList.Term>
> >     </dt>
> >
> >     <dd>
> >       “\{\\"db\_name\\":\\"csvdb\\",\\"tables\\":\[\{\\"table\_name\\":\\"staff\\",\\"data\_path\\":\\"test.csv\\",\\"columns\\":\[\{\\"column\_name\\":\\"id\\",\\"column\_type\\":\\"1\\"}]}]}”
> >     </dd>
> >   </dl>
> > </DefinitionList>

:target{#routing-rules}

##### 路由规则

embed\_router 的规则支持通配符 ‘\*’，当给定格式为 database\_name\:table\_name 的表时，embed\_router 将通过以下方式路由到相应的数据源：

```default
1. find the exact rules first, whose `${db}:${table}` equals to database_name:table_name;
2. try the database_name:* rules;
3. try *:table_name in the end.
```

一旦找到，SCQLEngine将尝试使用与 datasource\_id 对应的数据源信息连接数据库。

:target{#config-for-brpc-server}

#### Brpc 服务器配置

SCQLEngine 使用 Brpc 与 SCDB 和其他对等 SCQLEngine 进行通信，每个 SCQLEngine 都会在 local-host\:listen\_port 上启动 Brpc 服务以接收来自外部的数据。如果要启用 Brpc 内置服务，请添加 FLAGS：

```default
--enable_builtin_service=true
--internal_port=9527
```

:target{#config-for-ssl}

#### SSL配置

如果要在 Engine 中启用 SSL，请添加 FLAGS，如下所示。 此外，可能需要配置 SCDB 与 TLS 一起运行，请参阅“TLS 配置”。

```default
--server_enable_ssl=true
--server_ssl_certificate=${file path of cert}
--server_ssl_private_key=${file path of key}
--peer_engine_enable_ssl_as_client=true
--scdb_enable_ssl_as_client=true
```
