---
title: "[暂时不同步出去] 基于自定义Secretflow组件运行作业"
toc: content
dateModified: 2023-07-24T09:11:31.000Z
---
<!doctype html><div class="lake-content" typography="classic"><p id="ua18d57d4" class="ne-p"><br></p><p id="u1370b4c2" class="ne-p"><br></p><p id="u8fea4a29" class="ne-p"><br></p><h2 id="OI0TT" data-lake-index-type="2"><span lake-read-ignore="true">1. </span><span class="ne-text">更新组件列表和注册镜像</span></h2><p id="ub964624c" class="ne-p"><span class="ne-text">该步骤包括以下两部分内容：</span></p><ul class="ne-ul"><li id="uf0d2422b" data-lake-index-type="0"><span class="ne-text">更新平台组件列表，使之包含自定义组件</span></li><li id="ud8faef79" data-lake-index-type="0"><span class="ne-text">注册包含自定义组件的Secretflow镜像</span></li></ul><h3 id="AXsZL" data-lake-index-type="2"><span lake-read-ignore="true">1.1. </span><span class="ne-text">准备工具脚本</span></h3><p id="u3a5c043a" class="ne-p"><span class="ne-text">在本地新建脚本文件</span><code class="ne-code"><span class="ne-text">load-customized-sf.sh</span></code><span class="ne-text">，并将下面内容拷贝到该文件中。</span></p><pre data-language="shell" id="CS7jx" class="ne-codeblock language-shell"><code>#!/bin/bash
#
# Copyright 2023 Ant Group Co., Ltd.
#
# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

SF_IMAGE=&quot;secretflow-registry.cn-hangzhou.cr.aliyuncs.com/secretflow/secretflow-lite-anolis8:latest&quot;
DEPLOY_USER=&quot;${USER}&quot;

usage=&quot;$(basename &quot;$0&quot;) [OPTIONS]

OPTIONS:
    -h    show this help text
    -u    the user name of deploying the secretpad and kuscia container, default value: ${USER}
    -i    secretflow image info, default value: secretflow-registry.cn-hangzhou.cr.aliyuncs.com/secretflow/secretflow-lite-anolis8:latest

example:
 ./load_customized_sf.sh -u ${USER} -i secretflow-registry.cn-hangzhou.cr.aliyuncs.com/secretflow/secretflow-lite-anolis8:latest
&quot;

while getopts ':hi:u:' option; do
  case &quot;$option&quot; in
  h)
    echo &quot;$usage&quot;
    exit
    ;;
  i)
    SF_IMAGE=$OPTARG
    ;;
  u)
    DEPLOY_USER=$OPTARG
    ;;
  \?)
    echo -e &quot;Invalid option: -$OPTARG&quot; &amp;&amp; echo &quot;${usage}&quot;
    exit 1
    ;;
  esac
done


CTR_ROOT=&quot;/home/kuscia&quot;
SECRETPAD_CONTAINER_NAME=&quot;${DEPLOY_USER}-kuscia-secretpad&quot;
KUSCIA_MASTER_CONTAINER_NAME=&quot;${DEPLOY_USER}-kuscia-master&quot;
KUSCIA_ALICE_LITE_CONTAINER_NAME=&quot;${DEPLOY_USER}-kuscia-lite-alice&quot;
KUSCIA_BOB_LITE_CONTAINER_NAME=&quot;${DEPLOY_USER}-kuscia-lite-bob&quot;

SF_TEMP_DIR=&quot;/tmp/sf-tmp&quot;
COMP_LIST=&quot;&quot;
COMP_LIST_FILE=&quot;sf_comp_list.json&quot;
COMP_TRANSLATION=&quot;&quot;
COMP_TRANSLATION_FILE=&quot;sf_comp_translation.json&quot;
APP_IMAGE_FILE=&quot;sf-appimage.yaml&quot;

APP_IMAGE_REPO=&quot;secretflow-registry.cn-hangzhou.cr.aliyuncs.com/secretflow&quot;

function prepare_app_image() {
  echo &quot;&quot;
  echo &quot;start preparing app image...&quot;
  image_name=$1
  image_tag=$2

  image_tar=${SF_TEMP_DIR}/$(echo ${image_name} | sed 's/\//_/g' ).tar
  if [[ ! -e ${image_tar} ]] ; then
    docker save &quot;${SF_IMAGE}&quot; -o &quot;${image_tar}&quot;
  fi

  echo &quot;import app image into ${KUSCIA_ALICE_LITE_CONTAINER_NAME} container&quot;
  docker exec -it &quot;${KUSCIA_ALICE_LITE_CONTAINER_NAME}&quot; ctr -a=${CTR_ROOT}/containerd/run/containerd.sock -n=k8s.io images import &quot;${image_tar}&quot;

  echo &quot;import app image into ${KUSCIA_BOB_LITE_CONTAINER_NAME} container&quot;
  docker exec -it &quot;${KUSCIA_BOB_LITE_CONTAINER_NAME}&quot; ctr -a=${CTR_ROOT}/containerd/run/containerd.sock -n=k8s.io images import &quot;${image_tar}&quot;

  numbers=$(echo &quot;${image_name}&quot; | grep -o &quot;/&quot; | wc -l)
  if [[ $numbers -ne 2 ]]; then
      iname=${image_name##*/}
      origin_image=&quot;docker.io/library/${iname}:${image_tag}&quot;
      image_name_tag_in_ctr=&quot;${APP_IMAGE_REPO}/${iname}:${image_tag}&quot;
      docker exec -it &quot;${KUSCIA_ALICE_LITE_CONTAINER_NAME}&quot; ctr -a=${CTR_ROOT}/containerd/run/containerd.sock images tag &quot;${origin_image}&quot; &quot;${image_name_tag_in_ctr}&quot;
      docker exec -it &quot;${KUSCIA_BOB_LITE_CONTAINER_NAME}&quot; ctr -a=${CTR_ROOT}/containerd/run/containerd.sock images tag &quot;${origin_image}&quot; &quot;${image_name_tag_in_ctr}&quot;
  fi

echo &quot;
apiVersion: kuscia.secretflow/v1alpha1
kind: AppImage
metadata:
  name: secretflow-image
spec:
  configTemplates:
    task-config.conf: |
      {
        \&quot;task_id\&quot;: \&quot;{{.TASK_ID}}\&quot;,
        \&quot;task_input_config\&quot;: \&quot;{{.TASK_INPUT_CONFIG}}\&quot;,
        \&quot;task_cluster_def\&quot;: \&quot;{{.TASK_CLUSTER_DEFINE}}\&quot;,
        \&quot;allocated_ports\&quot;: \&quot;{{.ALLOCATED_PORTS}}\&quot;
      }
  deployTemplates:
    - name: secretflow
      replicas: 1
      spec:
        containers:
          - command:
              - sh
            args:
              - -c
              - python -m secretflow.kuscia.entry /etc/kuscia/task-config.conf
            configVolumeMounts:
              - mountPath: /etc/kuscia/task-config.conf
                subPath: task-config.conf
            name: secretflow
            ports:
              - name: spu
                port: 54509
                protocol: GRPC
                scope: Cluster
              - name: fed
                port: 8080
                protocol: GRPC
                scope: Cluster
              - name: global
                port: 8081
                protocol: GRPC
                scope: Domain
            workingDir: /work
        restartPolicy: Never
  image:
    id: abc
    name: ${image_name}
    sign: abc
    tag: ${image_tag}
---
apiVersion: kuscia.secretflow/v1alpha1
kind: AppImage
metadata:
  name: secretflow-nsjail-image
spec:
  configTemplates:
    task-config.conf: |
      {
        \&quot;task_id\&quot;: \&quot;{{.TASK_ID}}\&quot;,
        \&quot;task_input_config\&quot;: \&quot;{{.TASK_INPUT_CONFIG}}\&quot;,
        \&quot;task_cluster_def\&quot;: \&quot;{{.TASK_CLUSTER_DEFINE}}\&quot;,
        \&quot;allocated_ports\&quot;: \&quot;{{.ALLOCATED_PORTS}}\&quot;
      }
  deployTemplates:
    - name: secretflow
      replicas: 1
      spec:
        containers:
          - command:
              - sh
            args:
              - -c
              - sh .nsjail/run.sh
            configVolumeMounts:
              - mountPath: /etc/kuscia/task-config.conf
                subPath: task-config.conf
            name: secretflow
            ports:
              - name: spu
                port: 54509
                protocol: GRPC
                scope: Cluster
              - name: fed
                port: 8080
                protocol: GRPC
                scope: Cluster
              - name: global
                port: 8081
                protocol: GRPC
                scope: Domain
            workingDir: /root
            securityContext:
              privileged: true
        restartPolicy: Never
  image:
    id: abc
    name: ${image_name}
    sign: abc
    tag: ${image_tag}
&quot; &gt; &quot;${SF_TEMP_DIR}/${APP_IMAGE_FILE}&quot;

  docker exec -it &quot;${KUSCIA_MASTER_CONTAINER_NAME}&quot; kubectl apply -f &quot;${SF_TEMP_DIR}/${APP_IMAGE_FILE}&quot;

  echo &quot;finish preparing app image&quot;
}

function parse_sf_image_labels() {
  comp_list=$(docker inspect -f '{{ index .Config.Labels &quot;kuscia.secretflow.comp_list&quot; }}' ${SF_IMAGE})
  comp_translation=$(docker inspect -f '{{ index .Config.Labels &quot;kuscia.secretflow.translation&quot; }}' ${SF_IMAGE})

  if [[ comp_list == &quot;&quot; ]]; then
   echo &quot;label kuscia.secretflow.comp_list can't be empty in sf image&quot;
   exit 1
  fi

  if [[ comp_translation == &quot;&quot; ]]; then
    echo &quot;label kuscia.secretflow.translation can't be empty in sf image&quot;
    exit 1
  fi

  if [[ ! -d ${SF_TEMP_DIR} ]]; then
    mkdir ${SF_TEMP_DIR}
  fi

  echo &quot;${comp_list}&quot; &gt; &quot;${SF_TEMP_DIR}/${COMP_LIST_FILE}&quot;
  echo &quot;${comp_translation}&quot; &gt; &quot;${SF_TEMP_DIR}/${COMP_TRANSLATION_FILE}&quot;
}

function update_sf_config_into_secretpad() {
  echo &quot;&quot;
  echo &quot;start updating secretflow config of secretpad container...&quot;
  parse_sf_image_labels
  docker cp &quot;${SF_TEMP_DIR}/${COMP_LIST_FILE}&quot; &quot;${SECRETPAD_CONTAINER_NAME}:/app/config/components/secretflow.json&quot; || exit 1
  docker cp &quot;${SF_TEMP_DIR}/${COMP_TRANSLATION_FILE}&quot; &quot;${SECRETPAD_CONTAINER_NAME}:/app/config/i18n/secretflow.json&quot; || exit 1

  docker restart &quot;${SECRETPAD_CONTAINER_NAME}&quot; &gt; /dev/null
  echo &quot;finish updating secretflow config of secretpad container&quot;
}

function post_action() {
  echo &quot;&quot;
  echo &quot;remove temporary directory ${SF_TEMP_DIR}&quot;
  rm -rf &quot;${SF_TEMP_DIR}&quot;
}

function load_customized_sf() {
  echo &quot;secretflow image: ${SF_IMAGE}&quot;
  image_name=$(echo &quot;${SF_IMAGE}&quot; | awk -F &quot;:&quot; '{print $1}')
  image_tag=$(echo &quot;${SF_IMAGE}&quot; | awk -F &quot;:&quot; '{print $2}')

  if [[ &quot;${image_name}&quot; = &quot;&quot; ]]; then
    echo &quot;split image ${SF_IMAGE} failed&quot;
    exit 1
  fi

  if [ &quot;${image_tag}&quot; = &quot;&quot; ]; then
    image_tag=&quot;latest&quot;
  fi

  update_sf_config_into_secretpad
  prepare_app_image &quot;${image_name}&quot; &quot;${image_tag}&quot;
  post_action
}

load_customized_sf</code></pre><h3 id="EAGDJ" data-lake-index-type="2"><span lake-read-ignore="true">1.2. </span><span class="ne-text">运行工具脚本</span></h3><pre data-language="shell" id="fvGuq" class="ne-codeblock language-shell"><code># 修改工具脚本权限
chmod +x load-customized-sf.sh

# 执行工具脚本
./load-customized-sf.sh -u {部署Kuscia和MVP平台所使用的USER} -i {包含自定义组件的Secretflow镜像}

# 示例: 
## -u: 若不指定，则使用默认USER，通过命令 echo $USER 查看。若部署MVP平台和Kuscia时，未指定该参数，则可以忽略该参数
## -i: 若不指定，则使用默认Image：&quot;secretflow-registry.cn-hangzhou.cr.aliyuncs.com/secretflow/secretflow-lite-anolis8:latest&quot;
./load-customized-sf.sh -u root -i secretflow-registry.cn-hangzhou.cr.aliyuncs.com/secretflow/secretflow-lite-anolis8:latest

# 查看帮助信息
./load-customized-sf.sh -h</code></pre><p id="ua5f69f86" class="ne-p"><span class="ne-text"></span></p><h2 id="iD1zF" data-lake-index-type="2"><span lake-read-ignore="true">2. </span><span class="ne-text">检查组件是否更新成功</span></h2><ul class="ne-ul"><li id="ufda10072" data-lake-index-type="0"><span class="ne-text">登录MVP平台，查看平台是否包含自定义组件</span></li><li id="u23cdbf1f" data-lake-index-type="0"><span class="ne-text">使用自定义组件，运行作业</span></li></ul></div>