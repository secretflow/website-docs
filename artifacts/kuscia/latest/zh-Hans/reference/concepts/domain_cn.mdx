:target{#domain}

# Domain

在 Kuscia 中将隐私计算的节点称为 Domain，一个 Domain 中可以包含多个 K8s 的工作节点（Node）。Kuscia
复用了 K8s 的 Namespace 机制来管理节点权限，一个 Domain 对应 K8s 中的一个 Namespace。你可以使用 Domain 来管理和维护隐私计算节点。具体用例请参考下文。

:target{#id1}

## 用例

以下是一些 Domain 的典型用例：

- 创建 Domain，你将体验如何使用 Domain 创建隐私计算节点相关的 Namespace, ResourceQuota 资源。
- 更新 Domain，你将熟悉如何更新现有的 Domain，从而变更隐私计算节点相关的 Namespace, ResourceQuota 资源。
- 清理 Domain，你将熟悉如何清理不需要的 Domain。在 Kuscia 中，清理 Domain 并不会真正的删除 Domain 相关的 Namespace, ResourceQuota 资源，而是会在节点相关的 Namespace 资源上添加标记 Domain 被删除相关标签。
- 参考 Domain 对象定义，你将获取详细的 Domain 描述信息。

:target{#id2}

## 创建 Domain

下面以 <code>alice-domain.yaml</code> 的内容为例，介绍创建 Domain。

```yaml
apiVersion: kuscia.secretflow/v1alpha1
kind: Domain
metadata:
  name: alice
spec:
  role: partner
  cert: base64<certificate>
  resourceQuota:
    podMaxCount: 100
```

在该示例中:

- <code>.metadata.name</code>：表示隐私计算节点 Domain 名称，当前示例为<code>alice</code>。相应地，Kuscia 控制器会创建名称和 Domain 同名的<code>alice</code> Namespace 资源。在 Kuscia 中，通过 Namespace 资源对不同机构用户进行资源隔离。
- <code>.spec.role</code>：表示隐私计算节点 Domain 的角色，默认为<code>""</code>。支持两种取值：<code>partner</code>和<code>""</code>。
  - <code>partner</code>：表示外部节点，用在点对点组网模式下的协作方节点。点对点组网模式下，需要在任务调度方的集群中创建协作方的 Domain，在创建该 Domain 时，需要将<code>role</code>的值设置为<code>partner</code>。
  - <code>""</code>：表示内部节点。
- <code>.spec.cert</code>：表示 BASE64 编码格式的隐私计算节点证书。
- <code>.spec.resourceQuota.podMaxCount</code>：表示 Domain 所管理的隐私计算节点命名空间（Namespace）下所允许创建的最大 Pod 数量，当前示例为<code>100</code>。

1. 运行以下命令创建 Domain。

```shell
kubectl apply -f alice-domain.yaml
```

2. 检查 Domain 是否创建成功。

```shell
kubectl get domain alice
NAME    AGE
alice   3s
```

3. 检查 Domain 相关的 Namespace, ResourceQuota 资源是否创建成功。

```shell
kubectl get namespace alice
NAME     STATUS   AGE
alice    Active   18s

kubectl get resourcequota -n alice
NAME                  AGE   REQUEST      LIMIT
resource-limitation   18s   pods: 0/100
```

:target{#id3}

## 更新 Domain

下面以 <code>alice-domain.yaml</code> 的内容为例，介绍更新 Domain。

```yaml
apiVersion: kuscia.secretflow/v1alpha1
kind: Domain
metadata:
  name: alice
spec:
  role: partner
  cert: base64<certificate>
  resourceQuota:
    podMaxCount: 200
```

在该示例中:

- 将<code>.spec.resourceQuota.podMaxCount</code>的值调整为<code>200</code>。

1. 运行以下命令更新 Domain。

```shell
kubectl apply -f alice-domain.yaml
```

2. 检查 Domain 相关的 ResourceQuota 资源是否更新成功。

```shell
kubectl get resourcequota -n alice
NAME                  AGE   REQUEST      LIMIT
resource-limitation   4m    pods: 0/200
```

:target{#id4}

## 清理 Domain

下面以 Domain <code>alice</code> 为例，介绍清理 Domain。

1. 运行以下命令清理 Domain。

```shell
kubectl delete domain alice
```

2. 检查 Domain 是否已被清理。

```shell
kubectl get domain alice
Error from server (NotFound): domains.kuscia.secretflow "alice" not found
```

3. 检查 Domain 相关的 Namespace, ResourceQuota 资源是否还存在。

```shell
kubectl get namespace alice
NAME    STATUS   AGE
alice   Active   20m

kubectl get resourcequota -n alice
NAME                  AGE    REQUEST      LIMIT
resource-limitation   20m    pods: 0/200
```

4. 检查 Domain 相关的 Namespace 是否已添加标记被清理的标签。

```shell
kubectl get namespace alice -L kuscia.secretflow/deleted
NAME    STATUS   AGE   DELETED
alice   Active   20m   true
```

:target{#id5}

## 参考

下面以 <code>domain-template</code> 模版为例，介绍 Domain 所包含的完整字段。

```yaml
apiVersion: kuscia.secretflow/v1alpha1
kind: Domain
metadata:
  name: domain-template
spec:
  role: partner
  cert: base64<certificate>
  interConnProtocols: 
  - kuscia
  resourceQuota:
    podMaxCount: 100
status:
  nodeStatuses:
    - lastHeartbeatTime: "2023-04-06T08:49:14Z"
      lastTransitionTime: "2023-04-04T12:20:40Z"
      name: 809406b513d3
      status: Ready
      version: e9a8013
```

Domain <code>metadata</code> 的子字段详细介绍如下：

- <code>name</code>：表示隐私计算节点 Domain 的名称，当前示例为<code>domain-template</code>。相应地，Kuscia 控制器会创建名称和 Domain 同名的<code>domain-template</code> Namespace 资源。在 Kuscia 中，通过 Namespace 资源对不同机构用户进行资源隔离。

Domain <code>spec</code> 的子字段详细介绍如下：

- <code>role</code>：表示隐私计算节点 Domain 的角色，默认为<code>""</code>。支持两种取值：<code>partner</code>和<code>""</code>。
  - <code>partner</code>：表示外部节点，用在点对点组网模式下的协作方节点。 点对点组网模式下，需要在任务调度方的集群中创建协作方的 Domain，在创建该 Domain 时，需要将<code>role</code>的值设置为<code>partner</code>。
  - <code>""</code>：表示内部节点。
- <code>cert</code>：表示 BASE64 编码格式的隐私计算节点证书。用于节点之间 Token 协商或 TLS 认证。
- <code>interConnProtocols</code>：表示外部隐私计算节点支持的互联互通作业协议类型，默认为<code>""</code>。支持两种取值：<code>kuscia</code>和<code>bfia</code>。当前该字段只支持配置一种协议，若配置多个协议，则会选择第一个协议作为互联互通作业的协议类型。未来会支持多种协议。
  - <code>kuscia</code>：表示该外部节点参与隐私计算任务时，会使用互联互通蚂蚁<code>kuscia</code>协议运行隐私计算任务。
  - <code>bfia</code>：表示该外部节点参与隐私计算任务时，会使用互联互通银联<code>bfia</code>协议运行隐私计算任务。
- <code>resourceQuota.podMaxCount</code>：表示 Domain 所管理的隐私计算节点 Namespace 下所允许创建的最大 Pod 数量，当前示例为<code>100</code>。相应地，Kuscia 控制器会在<code>domain-template</code> Namespace 下创建名称为<code>resource-limitation</code>的 ResourceQuota 资源。

Domain <code>status</code> 的子字段详细介绍如下：

- <code>nodeStatuses</code>：表示隐私计算节点 Domain 下所有 Kuscia Agent 的状态信息。
  - <code>nodeStatuses\[].lastHeartbeatTime</code>：表示 Kuscia Agent 最近一次上报心跳的时间。
  - <code>nodeStatuses\[].lastTransitionTime</code>：表示 Kuscia Agent 最近一次发生更新的时间。
  - <code>nodeStatuses\[].name</code>：表示 Kuscia Agent 的名称。
  - <code>nodeStatuses\[].status</code>：表示 Kuscia Agent 的状态。支持两种取值<code>Ready</code>、<code>NotReady</code>。
    - <code>Ready</code>：表示 Kusica Agent 状态正常。
    - <code>NotReady</code>：表示 Kusica Agent 状态异常。
  - <code>nodeStatuses\[].version</code>：表示 Kuscia Agent 的版本。
