:target{#domaindata}

# DomainData

在 Kuscia 中，DomainData 表示被 Kuscia 所管理的数据对象，包括 表、模型、规则和报告等。DomainData 属于节点内资源，每一个 DomainData 都有自己所属的 Domain，且仅能被自己所属的 Domain 访问。

一个常见的用例是：隐私求交参与方分别在自己的 Domain 下创建出自己要参与计算的表，即<code>type</code>为<code>table</code>的 DomainData，然后创建一个 [KusciaJob](kusciajob_cn.mdx) 进行隐私求交任务，
该任务结束后，会在参与方生成新的隐私求交结果表，即生成<code>type</code>为<code>table</code>的 DomainData，参与方可以通过这个 DomainData 获取到文件地址或者将这个 DomainData 用于下次计算任务。

值得注意的是：无论是创建、更新、清理 DomainData，都不会对真实的数据内容产生影响，Kuscia 仅仅记录数据的 meta 信息，用于在计算任务中协助应用算法组件读取数据。
当前版本 Kuscia 暂未支持检查真实的数据内容是否满足 DomainData 中提交的 meta 信息定义，后续 Kuscia 会增加对提交的 meta 信息的验证。

如上所述，你可以通过创建一个 DomainData 将你自己的数据加入 Kuscia 的管理，也可以通过任务生成一个新的 DomainData 。

:target{#id1}

## 用例

以下是一些 DomainData 的典型用例：

- 创建 DomainData，你将体验如何使用通过创建一个 DomainData 将你自己的数据加入 Kuscia 的管理。
- 更新 DomainData，你将熟悉如何更新现有的 DomainData，从而变更 DomainData 的信息。
- 清理 DomainData，你将熟悉如何清理不需要的 DomainData。删除 DomainData 并不会删除真实的数据，只是 Kuscia 不再管理这些数据。
- 参考 DomainData 对象定义，你将获取详细的 DomainData 描述信息。

:target{#id2}

## 创建 DomainData

下面以 <code>alice-table.yaml</code> 的内容为例，介绍创建 DomainData。

```yaml
apiVersion: kuscia.secretflow/v1alpha1
kind: DomainData
metadata:
  labels:
    kuscia.secretflow/domaindata-type: table
    kuscia.secretflow/domaindata-vendor: manual
  name: alice-table
  namespace: alice
spec:
  attributes:
    description: alice demo data
  columns:
    - comment: ""
      name: id1
      type: str
    - comment: ""
      name: age
      type: float
    - comment: ""
      name: education
      type: float
  dataSource: default-data-source
  name: alice.csv
  relativeURI: alice.csv
  type: table
  vendor: manual
```

在该示例中:

- <code>.metadata.labels</code>：标签在 K8s 中用于支持高效的查询和监听操作，参考：[标签和选择算符](https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/)。
- <code>.metadata.name</code>：表示隐私计算节点 DomainData 的名称，当前示例为<code>alice-table</code>。
- <code>.metadata.namespace</code>: 表示 DomainData 所属的命名空间，即所属的节点，当前示例为<code>alice</code>。
- <code>.spec.attributes</code>：表示 DomainData 的自定义属性，以键值对形式表示，用作用户或应用算法为数据对象添加扩展信息，详细请查看 [参考](#refer)。
- <code>.spec.columns</code>：表示对于表类型的 DomainData 的列信息。仅当<code>type</code>为<code>table</code>时，该字段才存在，详细请查看 [参考](#refer)。
- <code>.spec.dataSource</code>：表示 DomainData 所属的数据源。数据源是数据所存放的位置，存在多种类型的数据源，详细请查看 [参考](#refer)。
- <code>.spec.name</code>：表示一个人类可读的名称，仅用作展示，可重复。
- <code>.spec.relativeURI</code>：表示相对于数据源根路径的位置，当前示例的绝对路径为<code>/home/kuscia/var/storage/data/alice.csv</code>，详细请查看 [参考](#refer)。
- <code>.spec.type</code>：表示 DomainData 的类型，目前支持 <code>table</code>、<code>model</code>、<code>rule</code>、<code>report</code>、<code>unknown</code>五种类型，分别表示数据表，模型，规则，报告和未知类型。
- <code>.spec.vendor</code>：表示 DomainData 的来源，仅用作标识，详细请查看 [参考](#refer)。

1. 准备你的 CSV 数据文件，将你的数据文件重命名为 <code>alice.csv</code>，并拷贝到alice节点容器即<code>$\{USER}-kuscia-lite-alice</code>容器的<code>/home/kuscia/var/storage/data</code>目录下，运行以下命令可完成：

```shell
mv {YOUR_CSV_DATA_FILE} alice.csv
docker cp alice.csv ${USER}-kuscia-lite-alice:/home/kuscia/var/storage/data/
```

2. 进入master容器即<code>$\{USER}-kuscia-master</code>容器，创建示例中的<code>alice-table.yaml</code>并根据你的 CSV文件 的列字段信息，调整上述示例中的<code>.spec.columns</code>字段。
3. 在master容器即<code>$\{USER}-kuscia-master</code>容器中，运行以下命令创建 DomainData。

```shell
kubectl apply -f alice-table.yaml
```

4. 在master容器即<code>$\{USER}-kuscia-master</code>容器中，检查 DomainData 是否创建成功。

```shell
kubectl get domaindata alice-table -n alice
```

:target{#id3}

## 更新 DomainData

下面以 <code>alice-table.yaml</code> 的内容为例，介绍更新 DomainData。

```yaml
apiVersion: kuscia.secretflow/v1alpha1
kind: DomainData
metadata:
  labels:
    kuscia.secretflow/domaindata-type: table
    kuscia.secretflow/domaindata-vendor: manual
  name: alice-table
  namespace: alice
spec:
  attributes:
    description: alice demo data
  columns:
    - comment: ""
      name: id1
      type: str
    - comment: ""
      name: age
      type: float
    - comment: ""
      name: education
      type: float
  dataSource: default-data-source
  name: alice.csv
  relativeURI: alice.csv
  type: table
  vendor: manual
```

在该示例中，将<code>.spec.name</code>的值调整为<code>alice-test.csv</code>。

1. 运行以下命令更新 DomainData。

```shell
kubectl apply -f alice-table.yaml
```

2. 检查 DomainData 是否更新成功。

```shell
kubectl get domaindata alice-table -n alice
```

:target{#id4}

## 清理 DomainData

下面以 DomainData <code>alice-table.yaml</code> 为例，介绍清理 DomainData。
注意：清理 DomainData 并不会清除真实的数据内容，只是从 Kuscia 中删除 DomainData 中所记录的 meta 信息。

1. 运行以下命令清理 DomainData。

```shell
kubectl delete domaindata alice-table -n alice
```

2. 检查 DomainData 是否已被清理。

```shell
kubectl get domaindata alice-table -n alice
Error from server (NotFound): domaindatas.kuscia.secretflow "alice-table" not found
```

:target{#refer}

## 参考

下面以 <code>alice-table</code> 模版为例，介绍 DomainData 所包含的完整字段。

```yaml
apiVersion: kuscia.secretflow/v1alpha1
kind: DomainData
metadata:
  labels:
    kuscia.secretflow/domaindata-type: table
    kuscia.secretflow/domaindata-vendor: manual
  name: alice-table
  namespace: alice
spec:
  attributes:
    description: alice demo data
  columns:
    - comment: ""
      name: id1
      type: str
    - comment: ""
      name: age
      type: float
    - comment: ""
      name: education
      type: float
  dataSource: default-data-source
  name: alice.csv
  relativeURI: alice.csv
  type: table
  vendor: manual
```

DomainData <code>metadata</code> 的子字段详细介绍如下：

- <code>labels</code>：标签在 K8s 中用于支持高效的查询和监听操作，参考：[标签和选择算符](https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/labels/)。
- <code>name</code>：表示隐私计算节点 DomainData 的名称，当前示例为<code>alice-table</code>。
- <code>namespace</code>：表示 DomainData 所属的命名空间，即所属的节点，当前示例为<code>alice</code>。

DomainData <code>spec</code> 的子字段详细介绍如下：

- <code>attributes</code>：表示 DomainData 的自定义属性，以键值对形式表示，用作用户或应用算法为数据对象添加扩展信息，Kuscia不感知，仅存储。你可以使用这个字段存储一些你自身业务属性的信息。
  比如你可以存储数据文件的md5值，或者存储行数，应用算法也可用于存储模型的类型等。
- <code>columns</code>：表示对于表类型的 DomainData 的列信息。仅当<code>type</code>为<code>table</code>时，该字段才存在。
  - <code>name</code>：列字段名称。
  - <code>type</code>：列字段的数据类型。该字段当前版本并非可枚举的，列字段的类型由应用算法组件进行定义和消费，Kuscia 仅作存储。
  - <code>comment</code>：列字段的注释，仅用作展示。
- <code>dataSource</code>：表示 DomainData 所属的数据源。数据源是数据所存放的位置，存在多种类型的数据源，比如<code>localfs</code>类型数据源表示节点内的一个文件目录，<code>mysql</code>类型数据源表示mysql实例中的一个数据库。
  目前 Kuscia 仅支持<code>localfs</code>数据源，并且内置一个数据源实例<code>default-data-source</code>，即当前示例中所使用的数据源。该<code>default-data-source</code>数据源的根目录为节点内的<code>/home/kuscia/var/storage/data</code>目录。
- <code>name</code>：表示一个人类可读的名称，仅用作展示，可重复。
- <code>relativeURI</code>：表示相对于数据源根路径的位置。对于<code>localfs</code>类型数据源来说，是相对于<code>localfs</code>类型数据源所表示的文件目录的相对位置，对于<code>mysql</code>类型数据源来说，是该mysql实例中的数据库的某个数据表。
  在该示例中是对于<code>default-data-source</code>数据源根目录的相对位置，即<code>/home/kuscia/var/storage/data/alice.csv</code>。
- <code>type</code>：表示 DomainData 的类型，目前支持 <code>table</code>、<code>model</code>、<code>rule</code>、<code>report</code>、<code>unknown</code>五种类型，分别表示数据表，模型，规则，报告和未知类型。
- <code>vendor</code>：表示 DomainData 的来源，仅用作标识，对于你手动创建的 DomainData，可以将其设置为<code>manual</code>，对于应用算法组件生成的表，由算法组件本身填充，secretflow算法组件会填充<code>secretflow</code>。
